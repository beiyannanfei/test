var moment = require('moment');

var datas = {
	"getDzpInfo": {
		"_id": "576d06c7fb8db79a41672c79",
		"name": "按时间段的",
		"limit": 100,
		"startTime": 1466763138000,
		"endTime": 1466922921000,
		"desc": "按时间段的",
		"bgImg": "http://q.cdn.mtq.tvm.cn/adsmall/pic/20160624180137-16493-1bctq48.jpg",
		"bgColor": "#000000",
		"turnplateImg": "http://tmall.mtq.tvm.cn/images/turntable/thanks-3.png",
		"followLimit": "1",
		"perTimes": 2,
		"prizes": [{
			"isDefault": 0,
			"prizeName": "100金币",
			"limitCount": 100,
			"id": "bf5c03b1d46943d2aeabae9cbdae0956",
			"rate": 1,
			"prizeType": 202,
			"value": 100,
			"rule": 1,
			"times": [{"startTime": "18:14", "endTime": "18:25", "count": 3}, {
				"startTime": "18:30",
				"endTime": "18:45",
				"count": 1
			}],
			"day": "1",
			"count": ""
		}, {
			"isDefault": 0,
			"prizeName": "10余额",
			"limitCount": 100,
			"id": "4621f8b4af8243f2b19c7c745b2b9588",
			"rate": 2,
			"prizeType": 201,
			"value": 10,
			"rule": 1,
			"times": [{"startTime": "18:14", "endTime": "18:25", "count": 5}],
			"day": "1",
			"count": ""
		}, {
			"isDefault": 1,
			"prizeName": "余额5",
			"id": "6a788034d31c44648557319507d5a920",
			"rate": 3,
			"prizeType": 201,
			"value": 5
		}],
		"dateTime": "2016-06-24T10:09:11.813Z",
		"dateTimeStr": "2016-06-24 18:09:11",
		"deleted": 0,
		"lastUpdateTime": "2016-06-24 18:19:03"
	},
	"userLottTimes": 8,
	"gerPartCount": 6,
	"checkBlack": false,
	"safeCheck": {
		"defaultPrize": [{
			"isDefault": 1,
			"prizeName": "余额5",
			"id": "6a788034d31c44648557319507d5a920",
			"rate": 3,
			"prizeType": 201,
			"value": 5
		}],
		"normalPrize": [{
			"isDefault": 0,
			"prizeName": "10余额",
			"limitCount": 100,
			"id": "4621f8b4af8243f2b19c7c745b2b9588",
			"rate": 2,
			"prizeType": 201,
			"value": 10,
			"rule": 1,
			"times": [{"startTime": "18:14", "endTime": "18:25", "count": 5}],
			"day": "1",
			"count": ""
		}, {
			"isDefault": 0,
			"prizeName": "100金币",
			"limitCount": 100,
			"id": "bf5c03b1d46943d2aeabae9cbdae0956",
			"rate": 1,
			"prizeType": 202,
			"value": 100,
			"rule": 1,
			"times": [{"startTime": "18:14", "endTime": "18:25", "count": 3}, {
				"startTime": "18:30",
				"endTime": "18:45",
				"count": 1
			}],
			"day": "1",
			"count": ""
		}]
	},
	"issuedNum": {
		"bf5c03b1d46943d2aeabae9cbdae0956": {"18:14": 0, "18:30": 0},
		"4621f8b4af8243f2b19c7c745b2b9588": {"18:14": 0}
	},
	"totolIssuedNum": {"bf5c03b1d46943d2aeabae9cbdae0956": 0, "4621f8b4af8243f2b19c7c745b2b9588": 0},
	"selectPrize": {
		"finanalPrize": {
			"isDefault": 1,
			"prizeName": "余额5",
			"id": "6a788034d31c44648557319507d5a920",
			"rate": 3,
			"prizeType": 201,
			"value": 5
		}, "minusFlag": true
	},
	"checkPrize": {
		"isDefault": 1,
		"prizeName": "余额5",
		"id": "6a788034d31c44648557319507d5a920",
		"rate": 3,
		"prizeType": 201,
		"value": 5
	},
	"savePrizeOrder": {
		"_id": "576d0977a047a1994193ce94",
		"tOpenId": "orEt2t-p47EYkrGc7i0Q1BUV-Bv4",
		"yyyappId": "qa-46497107fa23",
		"yOpenId": "orEt2t-p47EYkrGc7i0Q1BUV-Bv4",
		"localIp": "103.16.126.89",
		"isBlack": false,
		"dzpId": "576d06c7fb8db79a41672c79",
		"dzpName": "按时间段的",
		"prize": {
			"isDefault": 1,
			"prizeName": "余额5",
			"id": "6a788034d31c44648557319507d5a920",
			"rate": 3,
			"prizeType": 201,
			"value": 5
		},
		"user": {
			"uid": "",
			"openid": "orEt2t-p47EYkrGc7i0Q1BUV-Bv4",
			"nickname": "哈哈哈",
			"username": "哈哈哈",
			"country": "中国",
			"province": "北京",
			"city": "朝阳",
			"add_time": "1466742313",
			"weixin_last_time": "1466742313",
			"unionid": "",
			"sex": "1",
			"subscribe_time": "0",
			"weixin_avatar_url": "http://wx.qlogo.cn/mmopen/0gGy532gxEpPr77a8CYiaPNj7jCrrrmpXRBnCvo0UOSeCeib1HjxKavAQxI79nD7eHeIWxAJyMaMfJkDVKF7h6JQdYf9HWsCdw/0",
			"local_avatar_url": "http://m-cdn.mtq.tvm.cn/data/avatar/201606/1466742313.1040_8227.jpg",
			"avatar_url": "http://wx.qlogo.cn/mmopen/0gGy532gxEpPr77a8CYiaPNj7jCrrrmpXRBnCvo0UOSeCeib1HjxKavAQxI79nD7eHeIWxAJyMaMfJkDVKF7h6JQdYf9HWsCdw/0",
			"source": "1",
			"bonus": "0",
			"headimgurl": "http://wx.qlogo.cn/mmopen/0gGy532gxEpPr77a8CYiaPNj7jCrrrmpXRBnCvo0UOSeCeib1HjxKavAQxI79nD7eHeIWxAJyMaMfJkDVKF7h6JQdYf9HWsCdw/0",
			"lastUpdate": "1466763624052"
		},
		"dateTime": "2016-06-24T10:20:39.512Z",
		"dateTimeStr": "2016-06-24 18:20:39"
	},
	"sendPrize": "ok",
	"addUserPartTime": 9
};

function a() {
	var dzpInfo = datas.getDzpInfo;     //大转盘详细信息
	var issNumMap = datas.issuedNum;       //每个奖品当天或者每个时间段已经发放的数量
	var totalIssNumMap = datas.totolIssuedNum; //每个奖品当前总的发放数量
	var curlPart = datas.gerPartCount;      //当前参与人数
	var defaultPrizeList = datas.safeCheck.defaultPrize;    //默认将列表(已经打乱)
	var normalPrizeList = datas.safeCheck.normalPrize;      //正常奖品列表(已经打乱)
	var finanalPrize;
	var minusPartTimesFlag = false;     //参与次数扣除标志(应该发大奖，但是发了鼓励奖都要减一，即满足人数间隔但是发了鼓励奖就减一)
	var dzpId = dzpInfo._id.toString();     //大转盘id
	for (var index = 0; index < normalPrizeList.length; ++index) {
		var tempPrize = normalPrizeList[index];
		var prizeId = tempPrize.id;
		var perTimes = dzpInfo.perTimes;   //每隔多少个人中奖
		if (curlPart % perTimes != 0) {     //不满足人数间隔
			continue;
		}
		minusPartTimesFlag = true;  //已经满足人数间隔
		var limitCount = tempPrize.limitCount;  //封顶数量
		if (totalIssNumMap[prizeId] >= limitCount) {    //总的发放数量已经超过限制
			continue;
		}
		if (tempPrize.rule == 2) {      //按天的
			var count = tempPrize.count;    //每天限制发放数量
			if (issNumMap[prizeId] >= count) {  //当天发放超过限制
				continue;
			}
			finanalPrize = tempPrize;   //最终奖品确定
			break;
		}
		else {  //按照时间段的
			var nowMins = moment().get('hour') * 60 + moment().get('minute');
			var timeList = tempPrize.times;     //所有时间段
			for (var aIndex = 0; aIndex < timeList.length; ++aIndex) {
				var tempTimes = timeList[aIndex];
				var startTime = tempTimes.startTime;
				var endTime = tempTimes.endTime;
				var startList = startTime.split(":");
				var endList = endTime.split(":");
				var startMins = (+startList[0]) * 60 + (+startList[1]);
				var endMins = (+endList[0]) * 60 + (+endList[1]);
				console.log(nowMins, startMins, endMins);
				if (nowMins < startMins || nowMins > endMins) {     //不在时间段内
					continue;
				}
				var count = tempTimes.count;    //时间段内允许发放数量
				var timeLimit = issNumMap[prizeId][startTime];  //该奖品该时间段已经发放的数量
				if (timeLimit >= count) {   //改时间段已经发放完成
					break;  //符合一个时间段就一定不会符合其它时间段了，所以可以直接结束循环
				}
				finanalPrize = tempPrize;   //最终奖品确定
				break;
			}
			if (!!finanalPrize) {   //已经有符合条件的奖品了
				break;
			}
		}
	}
	if (!finanalPrize) {        //没有找到符合条件的大奖直接返回一个默认奖品
		console.log("111111111111111111111");
		finanalPrize = defaultPrizeList[0];
	}
	console.log(minusPartTimesFlag);
	console.log(finanalPrize);
}
a();