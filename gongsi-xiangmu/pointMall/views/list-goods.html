<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>商品列表</title>
    <link rel="stylesheet" type="text/css" media="screen" href="/pointMall/stylesheets/style.css" />

    <style type="text/css">
        .top_tit01{ padding:0 0 10px; border-bottom:solid 1px #d9dadc; font-size:16px;}
        .top_tit01 strong{ float:right; position:relative; top:-3px;padding:2px 10px; background:#0090ff; border-radius:4px; font-size:14px; color:#fff; font-weight:normal;}
        .top_tit01 strong:hover{ cursor:pointer; background:#0079d6;}
        .top_search{ overflow:hidden; clear:both; padding:10px 0 0; text-align:right}
        .top_search *{ font-size:13px}
        .top_search .w1{ width:160px; border:solid 1px #c9c9c9; padding:3px 4px;font-family:"微软雅黑"; border-radius:3px; box-shadow:inset 0 1px 3px #ddd; line-height:18px}
        .top_search .btn{ width:50px; height:26px; padding:1px 0 3px;border:solid 1px #c9c9c9; background:#f9f9f9;border-radius:3px; cursor:pointer }
        .top_search .btn:hover{ background:#eee}

        .t_form1{position:relative; margin-top:20px}
        .t_form1 dt{ clear:both; overflow:hidden; padding:6px 0; margin-bottom:10px; background:#95c2eb; color:#fff }
        .t_form1 dd{ clear:both; margin-bottom:15px;padding:25px 0; border:solid 1px #e7e7eb;width:100%;height:130px;}
        .t_form1 dd:hover{ background:#f9f9f9}
        .t_form1 th{ font-size:14px}
        .t_form1 td{ text-align:center; font-size:14px; color:#555}

        .t_form1 td.address{ position:relative; }
        .t_form1 td.address strong{display:inline-block; width:70px; border:solid 1px #ddd;padding:2px 0; background:#fff; border-radius:4px; font-size:14px; font-weight:normal; cursor:pointer}
        .t_form1 td.address strong:hover,.t_form1 td.address.on strong{ border:solid 1px #0090ff; color:#0090ff}
        .t_form1 td.address .url{ display:none; position:absolute; right:-50px; top:50%; margin-top:15px; background:#fff; border:solid 1px #ddd; padding:4px 6px; box-shadow:0 0 3px #ccc; border-radius:4px; white-space:nowrap }
        .t_form1 td.address .url i{ margin-left:10px; cursor:pointer; color:#0090ff}

        .t_form1 td.address.on .url{ display:block}
        .t_form1 td .e1{ width:80%; border:solid 1px #e7e7eb; padding:3px 4px 4px; font-family:"微软雅黑"; font-size:14px}
        .t_form1 td.good{ text-align:left}
        .t_form1 td.good img{ float:left; padding:2px; border:solid 1px #ddd; margin:0 15px 0 30px; max-width:100px; max-height:100px}
        .t_form1 td.good h3{ margin-top:7px;}
        .t_form1 td.good p{ margin-top:4px;}
        .operate1 strong{ display:inline-block; margin:0 5px; padding:3px 0; font-size:14px; border-radius:3px; font-weight:normal; color:#0090ff; cursor:pointer;}
        .operate1 strong:hover{ color:#0068b9}

        .pop_page1{ position:fixed; min-width:300px; background:#fff; border-radius:5px; box-shadow:0 1px 5px rgba(0,0,0,.2); display: none; top:50%; left:50%; width:420px;margin:-80px 0 0 -210px; z-index:10;}
        .pop_page1 .title{ height:45px; background:#0090ff; padding:0 15px;border-radius:5px 5px 0 0;}
        .pop_page1 .title strong{ float:left; color:#fff; font-size:14px; line-height:45px; font-weight:normal}
        .pop_page1 .title .close{ float:right; width:15px; height:15px; margin:15px 0 0; background:url(/pointMall/images/close.png) no-repeat center center; text-indent:-9999px; cursor:pointer}
        .pop_page1 .title .close:hover{opacity:.8; background-color:#000}
        .pop_page1 .cnt_code1{ margin:10px auto; text-align:center}
        .pop_page1 .cnt_code1 img{ width:160px; height:160px;}
        .pop_page1 .cnt_code1 p{ margin-top:8px; font-size:14px}
        .pop_page1 .cnt2{ margin:20px auto;}
        .pop_page1 .cnt2 .tip{ text-align:center; font-size:14px}
        .pop_page1 .cnt2 .btn{ margin-top:20px; text-align:center}
        .pop_page1 .cnt2 .btn strong{display:inline-block; width:85px; margin:0 5px; padding:5px 0; background:#0090ff; font-size:14px; border-radius:3px; font-weight:normal; color:#fff; cursor:pointer; text-align:center}
        .pop_page1 .cnt2 .btn strong.cancel{ background:#ff5252}

        /* add on 2014.12.23 */
        .top_search .w2{ width:140px; border:solid 1px #c9c9c9; padding:3px 4px;font-family:"微软雅黑"; border-radius:3px; box-shadow:inset 0 1px 3px #ddd; line-height:18px}
        .n_btn1{ margin-top:20px;}
        .n_btn1 strong{display:inline-block; width:85px; margin:0 20px 0 0; padding:5px 0; background:#0090ff; font-size:14px; border-radius:3px; font-weight:normal; color:#fff; cursor:pointer; text-align:center}
        .n_btn1 strong.cancel{ background:#ff5252}


        .pager_wapper{
            float:right;
        }
        .pager_wapper > div{
            float:left;
            padding:.3em .6em;
            margin:.3em;
            border:solid 1px gray;
            font-size:.9em;
            min-width:10px;
            text-align:center;
            cursor: pointer;
        }
        .pager_wapper > div:hover {
            background-color:rgb(210, 241, 255);
        }
        .pager_wapper .pager_current,.pager_wapper .pager_current:hover {
            background-color:rgb(242, 210, 255);
        }

        .clearFix{
            clear:both !important;
            float:none !important;
            width:0 !important;
            height:0 !important;
            border:none !important;
            padding:0 !important;
            margin:0 !important;
        }
    </style>

</head>
<body>
<div class="wrap01">
    <h2 class="top_tit01"><strong id="add-goods">添加商品</strong>商品管理</h2>
    <div class="top_search">
        <input type="button" id="export" value="导出统计表" style="float:left;background-color:#18ab04; color: #FFF; border: 0; padding: 4px 12px 6px; line-height: 100%; margin-left: 15px; cursor: pointer; margin-top: 10px;"/>
        <strong>按名字查询:</strong>
        <input placeholder="输入商品名字" type="text" id="txtFieldName" value="" style="padding:.27em;" />
        <select id="state" name="" class="w2">
            <option>全部</option>
            <option value="1">出售中</option>
            <option value="2">下架</option>
            <option value="3">库存中</option>
            <option value="10">已售罄</option>
        </select>
        <input id="search" name="" type="button" value="搜索" class="w1 btn" style="margin:0;">
    </div>

    <div class="goods_pager_top" style="margin-top:20px;text-align: right;"></div>
    <dl class="t_form1" id="list_goods" style="margin-top:5px;">
        <dt>
            <table width="100%" border="0" cellspacing="0" cellpadding="0">
                <colgroup>
                    <col width="5%">
                    <col width="25%">
                    <col width="10%">
                    <col width="10%">
                    <col width="10%">
                    <col width="20%">
                    <col width="20%">
                </colgroup>
                <tr>
                    <th>ID</th>
                    <th>商品</th>
                    <th>PV/UV</th>
                    <th>库存</th>
                    <th>总销量</th>
                    <th>创建日期</th>
                    <th>操作</th>
                </tr>
            </table>
        </dt>
    </dl>
    <div class="goods_pager_bottom" style="margin-top:5px;text-align: right;"></div>

    <div class="pager_tmpl pager_wapper" style="display:none;">
        <div class="pager_prev">上一页</div>
        <div class="pager_next">下一页</div>
        <div class="clearFix"></div>
    </div>

    <div class="n_btn1"><strong id="up">上架</strong><strong id="down" class="cancel">下架</strong></div>
</div>

<div id="qrcode-pop" class="pop_page1">
    <h2 class="title"><strong>二维码</strong><span class="close" title="关闭">关闭</span></h2>
    <div class="cnt_code1">
        <div class="pic"><img src=""></div>
        <p>小浣熊面面</p>
    </div>
</div>

<div id="delete-pop" class="pop_page1">
    <h2 class="title"><strong>删除</strong><span class="close" title="关闭">关闭</span></h2>
    <div class="cnt2">
        <div class="tip">确定要删除商品吗？</div>
        <div class="btn"><strong class="confirm">确定</strong><strong class="cancel">取消</strong></div>
    </div>
</div>
<script type="text/javascript" src="/pointMall/javascripts/jquery.min.js"></script>
<script type="text/javascript">
    $(function () {
        $.ajaxSetup({ cache: false });

        $('#add-goods').click(function(){
            window.location.href = '/pointMall/add/goods';
        })

        function getCheckGoodsIds(){
            var ids = []
            $('dd').find('input[type=checkbox]:checked').each(function(){
                var id = $(this).closest('dd').attr('goodsId');
                ids.push(id);
            })
            return ids;
        }

        function setGoodsState(ids, state){
            if (ids.length <= 0){
                return alert('请选择商品')
            }
            $.ajax({
                type: 'POST',
                url: '/pointMall/goods/state/' + state,
                data: {ids: ids},
                success: function(data){
                    alert('操作成功')
                    $('#search').click()
                },
                error: function(){
                    alert('操作失败')
                }
            })
        }

        $('#up').click(function(){
            var ids = getCheckGoodsIds()
            setGoodsState(ids, 1)
        })

        $('#down').click(function(){
            var ids = getCheckGoodsIds()
            setGoodsState(ids, 2)
        })

        $('#delete-pop').find('.confirm').click(function(){
            var goodsId = $('#delete-pop').attr('goodsId');
            deleteGoods(goodsId);
            $('#delete-pop').hide();
        })

        $('#delete-pop').find('.close').click(function(){
            $('#delete-pop').removeAttr('goodsId');
            $('#delete-pop').hide();
        })

        $('#delete-pop').find('.cancel').click(function(){
            $('#delete-pop').removeAttr('goodsId');
            $('#delete-pop').hide();
        })

        function deleteGoods(goodsId){
            $.ajax({
                type: 'DELETE',
                url: "/pointMall/goods/" + goodsId,
                success: function(data){
                    $('dd[goodsId=' + goodsId + ']').slideUp();
                },
                error: function(){
                    alert('删除失败');
                }
            })
        }

        function renderGoods(data) {
            var html = '';
            $.each(data, function(i, o){
                html += '<dd goodsId="' + o._id + '">' +
                        '<table width="100%" border="0" cellspacing="0" cellpadding="0"><colgroup>' +
                        '<col width="5%"><col width="25%"><col width="10%"><col width="10%"><col width="10%"><col width="20%"><col width="20%"></colgroup>' +
                        '<tr><td><input name="" type="checkbox" value=""></td><td class="good">' +
                        '<img src="' + o.pic + '">' +
                        '<h3>' + o.name + '</h3>' +
                        '<p>' + o.price + '</p></td><td>' + o.pv + '/' + o.uv + '</td><td>' + o.count + '</td><td>' + o.saleCount + '</td><td>' + o.dateTime + '</td><td>' +
                        '<div class="operate1">';
                if (o.ext.state == 1){
                    html += '<strong class="link" url="' + o.url + '">链接</strong>';
                } else if (o.type == 103 && o.ext.playType == 1){
                    html += '<strong class="link" url="' + o.url + '">链接</strong>';
                }
                /*html += '<strong class="qrcode">二维码</strong>';*/
                html += '<strong class="edit">编辑</strong><strong class="delete">删除</strong></div>' +
                    '</td></tr></table></dd>'
            })
            var newCell = $($.trim(html));
            $('#list_goods').find('dd').remove();
            $('#list_goods').append(newCell);

            if (clickBottomPager)
                window.scrollTo(0,document.body.scrollHeight);

            bindEvent(newCell);
        }

        var clickBottomPager = false;

        function pagerNavPager(target, pageIndex, pageCount) {
            var pagerNavSize    = 5;
            var pagerNavCount   = Math.ceil(pageCount / pagerNavSize);
            var pagerNavIndex   = Math.ceil(pageIndex / pagerNavSize);

            if(pagerNavCount <= 1) return;

            $('<div class="pager_more_prev">...</div>').insertAfter($(target).find(".pager_prev"));
            $('<div class="pager_more_next">...</div>').insertBefore($(target).find(".pager_next"));

            var pagerNavStart   = (pagerNavIndex - 1) * pagerNavSize;
            var pagerNavEnd     = pagerNavStart + pagerNavSize - 1;

            $(target).find(".pager_hand").each(function(index){
               if (index >= pagerNavStart && index <= pagerNavEnd) {
                   $(this).show();
               }else $(this).hide();
            });

            $(target).find(".pager_more_prev,.pager_more_next").on("click", function() {
               if ($(this).hasClass("pager_more_prev")) {
                   // prev
                   if (pagerNavIndex > 1) {
                       loadGoods($.extend({pageIndex:(pagerNavIndex - 1) * pagerNavSize - 5 + 1}, search));
                   }
               } else if ($(this).hasClass("pager_more_next")) {
                    // next
                   if (pagerNavIndex < pagerNavCount) {
                       loadGoods($.extend({pageIndex:pagerNavIndex * pagerNavSize + 1}, search));
                   }
               }
            });
        }

        var search = {};

        function renderPager(config, target) {
            var pageCount = config.pageCount;
            var pageIndex = config.pageIndex;

            if (pageCount <= 0) return;

            $(target).find(">div").remove();

            var vv = $(".pager_tmpl").clone().removeClass("pager_tmpl").show();

            for (var i=0; i<pageCount; i++) {
                var pager_hand = $("<div />")
                $(pager_hand).attr("class", pageIndex-1 == i ? "pager_hand pager_current" : "pager_hand").html(i+1)
                        .insertBefore($(vv).find(".pager_next"));
            }

            $(target).append($(vv)).append($('<div class="clearFix"></div>'));


            $(target).find(".pager_wapper").find(".pager_prev,.pager_next,.pager_hand").on("click", function() {
                var pageIndex = -1;

                if ($(this).hasClass("pager_hand")) {
                    if ($(this).hasClass("pager_current")) return;
                    pageIndex = parseInt($(this).html());
                } else if ($(this).hasClass("pager_prev")) {
                    // prev
                    if($(".pager_hand.pager_current").html() == "1") return;
                    pageIndex = parseInt($(".pager_hand.pager_current").html()) - 1;
                } else if ($(this).hasClass("pager_next")) {
                    // next
                    if($(".pager_hand.pager_current").html() == "" + pageCount) return;
                    pageIndex = parseInt($(".pager_hand.pager_current").html()) + 1;
                }

                if (pageIndex != -1) {
                    loadGoods($.extend({pageIndex:pageIndex}, search));
                }
            });

            pagerNavPager(target, pageIndex, pageCount);
        }

        function bindEvent(newCell){
            $('.delete', newCell).click(function(){
                var goodId = $(this).closest('dd').attr('goodsId');
                $('#delete-pop').attr('goodsId', goodId).show();
            })

            $('.link', newCell).click(function(){
                var url = $(this).attr('url');
                window.prompt("链接地址请复制", url);
            })

            $('.qrcode', newCell).click(function(){
                var goodId = $(this).closest('dd').attr('goodsId');

            })

            $('.edit', newCell).click(function(){
                var goodId = $(this).closest('dd').attr('goodsId');
                window.location.href = '/pointMall/goods/' + goodId + '/update';
            })
        }

        function loadGoods(params){
            var url = "/pointMall/list/goods?";
            $.map(params, function(v, k){
                url += '&' + k + '=' + v
            })
            $.ajax({
                type: 'GET',
                url: url,
                success: function(result){
                    var data = result.data;
                    //renderPager(result, $(".goods_pager_top"));
                    renderPager(result, $(".goods_pager_bottom"));


                    $(".goods_pager_bottom").find(".pager_hand,.pager_prev,.pager_next").on("click", function() {
                        clickBottomPager = true;
                    });

                    $(".goods_pager_top").find(".pager_hand,.pager_prev,.pager_next").on("click", function() {
                        clickBottomPager = false;
                    });

                    renderGoods(data);

                    if (data.length == 0){
                        $('#up').hide()
                        $('#down').hide()
                    } else if (params.state == '1'){
                        $('#up').hide()
                        $('#down').show()
                    } else if (params.state == '2'){
                        $('#up').show()
                        $('#down').hide()
                    } else if (params.state == '3'){
                        $('#up').show()
                        $('#down').show()
                    } else {
                        $('#up').show()
                        $('#down').show()
                    }

                },
                error: function(){

                }
            })
        }

        loadGoods({})

        $('#search').click(function(){
            clickBottomPager = false;

            if ($('#state').val().length > 0)
                search.state = $('#state').val();
            else delete search.state;

            if ($.trim($("#txtFieldName").val()).length > 0)
                search.keywordName = $.trim($("#txtFieldName").val());
            else delete search.keywordName;

            loadGoods(search)
        })

        $('#export').click(function(){
            window.open('/pointMall/export/goods/statistics')
        })
    });
</script>
</body>
</html>

