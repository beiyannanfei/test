<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>商品详情</title>
<style>
body,div,dl,dt,dd,ul,ol,li,h1,h2,h3,h4,h5,h6,pre,
form,fieldset,input,textarea,p,blockquote,th,td {padding: 0;margin: 0;}
table { border-collapse: collapse; border-spacing: 0;}
*{margin:0;padding:0;}
fieldset,img {border: 0;}
address,caption,cite,code,dfn,em,strong,th,var {font-weight: normal;font-style: normal;}
ol,ul {list-style: none;}
caption,th {text-align: left;}
.fl{float:left;}
.fr{float:right;}
html, body { background-color: #FFF;	}
body { font-size: 14px;}

.wrap{width:100%;height:100%;}
.top{width:100%;}
.top img{width:100%;}
.timer{font-size:24px;padding:20px 0 20px 45px;display:inline-block;background:url(/pointMall/images/pmall/clock.jpg) no-repeat 0 center;margin-left:20px; display: none;}
.top_time{height:40px;line-height:40px;position:absolute;right:0;top:25px;background:rgba(0,0,0,0.7);font-size:14px;color:#fff;padding:2px 20px 2px 10px;box-sizing:border-box;}
.top_time img{vertical-align:middle;margin-right:5px;}
.top_time span{display:inline-block;vertical-align:middle;:bolder;font-size:20px;}
.middle{background:#fff;padding:0 30px 10px 30px; margin-bottom: 50px;}
.middle h3{font-size:30px;line-height:1.5em; border-bottom:1px #d3d3d3 dashed; margin-bottom:18px;}
.price{color:#dc261b;font-size:18px;font-weight:bolder;}
.price span{font-size:36px;font-weight:bolder;}
.price .jiage{display:inline-block;}
.price i{margin:0 10px 0 10px;font-style:normal; font-size: 24px;}
.number{color:#939393;font-size:24px;padding:20px 0 20px 0;display:inline-block;}
.hint{font-size:18px;color:#939393;}
.popup{position:absolute;left:0;top:0;background:rgba(0,0,0,0.7);width:100%;height:100%;display:none;opacity:1;}
.popup_inner{width:600px;margin:0 auto;position:absolute;left:50%;top:50%;margin-left:-300px;margin-top:-130px;background:#e4e4e4;border-radius:10px;box-sizing:border-box;padding-top:15px;padding-bottom:20px;}
.popup_inner .ico{margin-left:-15px;margin-right:15px;}
.popup_right{padding-top:62px;width:380px;}
.popup_right p{font-size:32px;font-weight:bolder;}
.popup_right span{font-size:24px;margin:23px 0 29px 0;display:inline-block;}
.popup_right .btn{width:360px;height:65px;line-height:65px;text-align:center;cursor:pointer; background:#ea473e;color:#fff;border-radius:30px;font-size:30px;}
.close{position:absolute;right:23px;top:15px;}
.top_intergral{text-align:center;box-sizing:border-box;padding:5px 0 0 0;background:#fcfcfc;width:100%;box-shadow:1px -2px 5px 0px #C7C6C6;position:fixed;left:0;bottom:0; z-index: 99}
.convert{display:inline-block;background:#ea473e;padding:0px 30px;font-size:24px;color:#fff;border-radius:30px;height:60px;line-height:60px;box-sizing:border-box;cursor:pointer;margin:10px 15px;}
.convert_buy{background:#ef9000;}
.convert_buy:hover{background:#c67a06;}
.show{-webkit-animation:show .3s forwards;}
@-webkit-keyframes show{0%{-webkit-transform:scale(0);opacity:0}85%{-webkit-transform:scale(1.10);opacity:1}100%{-webkit-transform:scale(1);opacity:1}}

/*ClearFix */
.clearfix:after {content: ".";display: block;height: 0;clear: both;visibility: hidden;}
*html .clearfix {height:1%;}
*+html .clearfix{height:1%;}
.clearfix{display:inline-block;}
.clearfix {display:block;}
.clear{ clear:both; overflow:hidden;_zoom:1;}
.tab_list{display:none;}

.tab{border:1px #b5b5b5 solid;margin:15px 0;background:#fff;}
.tab li{float:left;height:66px;width:50%;text-align:center;font-size:28px;line-height:66px;border-right:1px #b5b5b5  solid;box-sizing:border-box;}
.tab li i{font-style:normal;color:#a6a6a6;}
.buy{color:#db2416;}
.tab_content{background:#fff;padding-bottom:85px;}
.tab_list{width:100%;text-align:center;font-size:24px;color:#9e9e9e;}
.tab_list tr{height:76px;border-bottom:1px #c1c1c1 solid;}
.uname{color:#414141;}
.headimg{width:60px;height:60px;border-radius:50%;}
.headimg img{width:60px;height:60px;border-radius:50%;}
.tab_time{text-align:right;padding-right:20px;}

.wrap_option{width:100%;height:100%;position:fixed;left:0;bottom:0;background:rgba(0,0,0,0.5); display: none; z-index: 9999;}
.option{position:absolute;left:0;bottom:0;width:100%;max-height: 75%; min-height:30%;background:#fff;border-top-left-radius:10px;border-top-right-radius:10px;overflow-y: auto;}

.option_close{position:absolute;right:20px;top:20px;}
.option_title{padding:20px 0 20px 20px; }
.img_ico{width:120px;height:120px;overflow:hidden;background:#f7f7f9;margin-right:13px;}
.img_ico img{width:100%;height:100%;}
.img_title p{font-size:26px;color:#999999;line-height:36px;padding:3px 0;}
.img_title .opaction_price{font-size:32px;color:#f20c0c;}

.option_con{background:#f6f6f6;padding:20px 0 20px 20px;color:#3e3d3d;font-size:26px;}
.select_top{padding:10px 0 20px 0;border-bottom:1px #dadada solid;margin-bottom:30px;}
.select_con{position:relative;border:2px #dadada solid;background:#fff;text-align:center;margin:0 30px 20px 0;box-sizing:border-box;padding:7px 12px;}
.sel_cur{position:absolute;right:0;top:0;height:40%;}
.select_cur{border:2px #f20c0c solid;}

.select_confirm{height:63px;width:100%;line-height:63px;color:#fff;font-size:30px;background:#ea473e;text-align:center;}

.progress{width:100%;box-sizing:border-box;height:67px;position:relative; margin:0 auto;}
.pro_con{width:100%;height:15px;background:#eeeeee;border-radius:7.5px;position:absolute;bottom:0px;}
.pro{width:0%;height:15px;background:#ffcd00;border-radius:7.5px;position:absolute;bottom:0px;}
.percent{color:#ffa742;height:37px;line-height:37px;position:absolute; font-size: 28px; }
.text{position:absolute;right:0;top:0;background:#ffcd00;color:#fff;padding:5px 8px;border-radius:3px; font-size: 24px; font-weight: bold;}
.text:after,.text:before{
    content:'';
    display:block;
    position:absolute;
    border-style:solid;
    border-width:10px;
    transform:translateX(-50%)
}
.text:before{
    border-color:#ffcd00 transparent transparent transparent;
    left:50%;
    bottom:-18px;
}
.text:after{
    border-color:#ffcd00 transparent transparent transparent;
    left:50%;
    bottom:-18px
}
.table{width:95%;margin:5px auto;font-size:22px;}
.table td{width:33%;margin:5px auto;padding:3px 0;}
.intro img{width: 100%; height:auto;}
.intro{border-bottom:1px #d3d3d3 dashed;border-top:1px #d3d3d3 dashed;margin-bottom:20px;padding:20px 0 15px 0; word-break:break-all;position: relative;}
.intro * {max-width: 100%;}

.shop_entr{border-radius: 10px; border: 1px #c9c9c9 solid;width:100%;padding:25px 10px;box-sizing:border-box;position:relative; margin:20px 0;}
.shop_entr img,.shop_entr span{vertical-align:middle;font-size:26px; margin-right: 20px; z-index: 99;}
.shop_entr a{padding:14px 20px;border-radius:20px;background:#ea473e;color:#fff;text-decoration:none;font-size:24px;position:absolute;right:10px;top:50%;-webkit-transform:translateY(-50%);}

.follow_pop_tip{ position:fixed;  top:50%; left:50%;-webkit-transform:translate(-50%,-50%); width:85%; background-color:#fff; border-radius:20px; display: none; z-index: 999;}
.follow_pop_tip .tip{ margin-top:15px; padding:40px 35px 10px 220px; min-height:100px; background:url(/pointMall/images/follow-ico.png) no-repeat 70px center; background-size:120px 120px; font-size:28px; line-height:1.4em; color:#888}
.follow_pop_tip .btn{ margin:20px 0; text-align:center}
.follow_pop_tip .btn strong{ display:inline-block; margin:0 4%; width:37%; height:70px;line-height:70px; background:#fff; background:-webkit-gradient(linear, left top, left bottom, from(#ebebeb), to(#d8d8d8)); border-radius:10px; font-size:28px; font-weight:normal; text-align:center; cursor:pointer; color:#666}
.follow_pop_tip .btn strong.focus{ background:-webkit-gradient(linear, left top, left bottom, from(#9fceeb), to(#67b2df)); color:#fff}
.follow_pop_tip .arrow{ position:absolute; width:14px; height:29px; background:url(/pointMall/images/follow-arrow.png) no-repeat 0 0; background-size:14px 29px; right:-13px; bottom:15%;}
@media all and (min-width:600px){

}
@media all and (max-width:320px){
    .follow_pop_tip .tip{ font-size:14px; padding-left:100px;background-size:65px 65px;min-height:65px;}
    .follow_pop_tip .btn strong{ font-size:15px; line-height:34px}
}
</style>
<script type="text/javascript" src="/pointMall/javascripts/hideWxMenu.js"></script>
</head>

<body>
<input type="hidden" id="prizeType" value="{{prize.type}}">
<input type="hidden" id="goodsId" value="{{prize._id}}">
<input type="hidden" id="playType" value="{{prize.ext.playType}}">
<input type="hidden" id="liveTime" value="{{prize.ext.liveTime}}">
<input type="hidden" id="endTime" value="{{prize.ext.endTime}}">
<input type="hidden" id="startTime" value="{{prize.ext.startTime}}">
<input type="hidden" id="sysTime" value="{{sysTime}}">
<input type="hidden" id="rule" value="{{prize.ext.rule}}">
<input type="hidden" id="isExchange" value="{{prize.isExchange}}">
<input type="hidden" id="isLottery" value="{{prize.isLottery}}">
<input type="hidden" id="lotteryId" value="{{lotteryId}}">
<input type="hidden" id="unFollowed" value="{{unFollowed}}">
<input type="hidden" id="followUrl" value="{{followUrl}}">
<input type="hidden" id="unload" value="">
<input type="hidden" id="vipSku" value="{{prize.daySku}}">
<input type="hidden" id="unablePay" value="{{unablePay}}">

<div class="follow_pop_tip">
    <div class="tip">亲，请先关注微信号!</div>
    <div class="btn"><strong class="cancel">取消</strong><strong class="follow">关注</strong></div>
    <span class="arrow"></span>
</div>

<div class="wrap_option">
    <div class="option">
        <div class="option_close"><img src="/pointMall/images/pmall/close_ico.png"></div>
        <div class="option_title clearfix">
            <div class="img_ico fl"><img src="{{prize.pic}}"></div>
            <div class="img_title fl">
                <p class="opaction_price">￥{{prize.price}}</p>
                <p>库存{{prize.count}}</p>
                <p>请选择尺码，颜色分类</p>
            </div>
        </div>
        <div class="option_con" id="rule-select">

        </div>
        <div class="select_confirm">确定</div>
    </div>
</div>
<div class="top_intergral">
    {{#if prize.isExchange}}
        <div id="convert" class="convert">立即兑换</div>
    {{else}}
        {{#if prize.isLottery}}
            <div id="lottery-convert" class="convert">立即兑奖</div>
        {{else}}
            <div id="buy" prizeId="{{prize._id}}" class="convert convert_buy">立即购买</div>
        {{/if}}
    {{/if}}
</div>
<div class="top">
    <img src="{{prize.pic}}"/>
</div>
<div class="middle">
	<h3 id="name">{{prize.name}}</h3>
    {{#if prize.isExchange}}
        <p class="price"><i>{{unit}}</i><span>{{prize.ext.score}}</span><span class="jiage" style="margin-left: 20px;">
            {{#unless prize.ext.hidePrice}}
                <i>￥</i>{{prize.price}}
            {{/unless}}
        </span></p>
    {{else}}
        <p class="price"><span class="jiage">￥{{prize.price}}</span></p>
    {{/if}}
    {{#unless prize.ext.hideCount}}
        <span class="number" count="{{prize.count}}">还剩{{prize.count}}件</span>
    {{/unless}}

    <div id="raise-progress" style="display: none;">
        <div class="progress">
            <div class="percent">0%</div>
            <div class="text">众筹中</div>
            <div class="pro_con"><div class="pro"></div></div>
        </div>
        <table class="table">
            <tr>
                <td align="left" class="money"></td>
                <td align="center" class="user-num"></td>
                <td align="right" class="day"></td>
            </tr>
            <tr>
                <td align="left">已筹集</td>
                <td align="center">支持者</td>
                <td align="right" class="state"></td>
            </tr>
        </table>
    </div>

    <div class="alltimer" style="clear: both;">
        <div id="live-timer" class="timer"></div>
        <div id="buy-timer" class="timer"></div>
    </div>
    {{#if prize.ext.store}}
        <div class="shop_entr">
            <img src="/pointMall/images/pmall/shop_ico.png">
            <span>{{prize.ext.store.name}}</span>
            <a href="/pointMall/inter/store/{{prize.ext.store.id}}" class="entr">去逛逛</a>
        </div>
    {{/if}}
    <div id="info" class="intro" info="{{prize.ext.detail}}">

    </div>
</div>
<div id="convertPopUp" class="popup">
    <div class="popup_inner">
    	<img class="close" src="/pointMall/images/pmall/close_ico.png">
        <img src="/pointMall/images/pmall/suc_ico.png" class="ico fl">
        <div class="popup_right fl">
            <p>确定花掉{{prize.ext.score}}{{unit}}吗？</p>
            <span>换购{{prize.name}}</span>
            <div prizeId="{{prize._id}}" class="btn">喵~果断兑换</div>
        </div>
    </div>
</div>
<div id="tip" class="popup">
    <div class="popup_inner">
        <img class="close" src="/pointMall/images/pmall/close_ico.png">
        <img src="/pointMall/images/pmall/suc_ico.png" class="ico fl">
        <div class="popup_right fl">
            <p>您的{{unit}}不够</p>
            <span>快去赚取{{unit}}吧</span>
        </div>
    </div>
</div>
<input type="hidden" id="integralUnit" value="{{unit}}">
<script type="text/javascript" src="/pointMall/javascripts/jquery.min.js"></script>
<script type="text/javascript" src="/pointMall/javascripts/wxShareApi.js"></script>
<script>
    //倒计时

    var unit = $('#integralUnit').val() || '积分';

    if(/Android (\d+\.\d+)/.test(navigator.userAgent)){
        var version = parseFloat(RegExp.$1);
        if(version>2.3){
            var phoneScale = parseInt(window.screen.width)/640;
            document.write('<meta name="viewport" content="minimal-ui, width=640, minimum-scale = '+ phoneScale +', maximum-scale = '+ phoneScale +', target-densitydpi=device-dpi">');
        }else{
            document.write('<meta name="viewport" content="minimal-ui, width=640, target-densitydpi=device-dpi">');
        }
    }else{
        document.write('<meta name="viewport" content="minimal-ui, width=640, user-scalable=no, target-densitydpi=device-dpi">');
    }

    window.loadShareParam = function(cb){
        var goodsId = $('#goodsId').val()
        $.ajax({
            method: 'POST',
            url: '/pointMall/goods/share/' + goodsId,
            data: {url: location.href.split('#')[0]},
            success: function(data){
                cb(null, data);
            },
            error: function(){
                cb('error')
            }
        })
    }

    $(function(){
        var unablePay = $('#unablePay').val();
        var DAY_TIME = 24 * 60 * 60 * 1000
        var HOUR_TIME = 60 * 60 * 1000
        var MINUTE_TIME = 60 * 1000
        var third = $('#third').val();
        var text = $('#info').attr('info');
        var prizeType = $('#prizeType').val();
        var startTime = $('#startTime').val()
        var endTime = $('#endTime').val()
        var isExchange = $('#isExchange').val()
        var isLottery = $('#isLottery').val()
        var lotteryId = $('#lotteryId').val()
        var prizeId = goodsId = $('#goodsId').val()
        var playType = $('#playType').val();
        var sysTime = parseInt($('#sysTime').val(), 10);

        function generateRule(arr){
            var domString = ''
            $.each(arr, function(i, o){
                domString += '<div class="fl select_con">' + o + '</div>'
            })
            return domString;
        }

        var rule = $('#rule').val();
        console.log('rule is:',rule);
        var isVip=false;
        (function(){
            var $vipSku=$('#vipSku'),
                    val=$vipSku.val().trim();

            if(val!==''){
                isVip=true;
                var data=JSON.parse(val);
                console.log('data is:',data);
                var $p=$('#rule-select');
                var domString = '<div class="option_con" id="rule-select">'+
                        '<div class="clearfix select" id="set-meal">'+
                        ' <h4 class="select_top">套餐分类</h4>';
                $.each(data, function(i, o){
                    if(!o.name){
                        o.name='套餐'+i;
                    }
                    domString += '<div data-day="'+ o.day+'" data-price="'+ o.price+'" class="fl select_con">' + o.name + '</div>'
                })

                domString+='</div></div>';
                $p.replaceWith($(domString));
                $p=$(domString);

                $('.img_title p').last().replaceWith($("<p>套餐天数:<span id='set-meal-day'></span>&nbsp;&nbsp;套餐价格:<span id='set-meal-price'></span></p>"));
                console.log('dom string is:',domString);
            }
        })();



        var hasRule = false;
        if (rule){
            try{
                rule = JSON.parse(rule)
            }catch(e){
                rule = null;
            }
            if(rule){
                $.map(rule, function(v, k){
                    hasRule = true
                    var $parent = $('#rule-select');
                    var domString = '<div class="clearfix select custom" title="' + k + '"><h4 class="select_top">' + k + '</h4>' + generateRule(v) + '</div>'
                    $parent.append(domString);
                })
            }
        }

        $(".select_con").click(function(){
            $(this).addClass("select_cur").append('<img src="/pointMall/images/sel.jpg" class="sel_cur" id="sel_cur">');
            $(this).siblings().removeClass("select_cur").children().remove();
            if(isVip===true){
                var day=$(this).attr('data-day');
                var price=$(this).attr('data-price');
                $('#set-meal-day').html(day);
                $('#set-meal-price').html('￥'+price);
                $('.opaction_price').html('￥'+price);
//                console.log('day is:',day,price);
            }
        }).first().click();
        /*关闭按钮*/
        $(".option_close").click(function(){
            $(".wrap_option").hide();
        });
        /*确定按钮*/
        $(".select_confirm").click(function(){
            $(".wrap_option").hide();
            if (isExchange){
                doChange()
            } else if (isLottery){
                doLotteryChange()
            } else {
                doBuy();
            }
        });

        while (text.indexOf('nowrap') >= 0){
            text = text.replace('nowrap', 'normal');
        }    
        var $view = $(text);
        $('#info').append($view);
        $('#info').attr('info', '');
        $('#info').find('img').css('width', '100%').css('height', 'auto').css('height', 'auto')

        function getXCTime(ts){
            var timeString = ''
            ts = Math.abs(ts);
            if (ts > DAY_TIME){
                var day = 0
                if (playType == 6){
                    day = 1
                }
                timeString += (parseInt(ts / DAY_TIME, 10) + day) + "天"
                ts -= parseInt(ts / DAY_TIME, 10) * DAY_TIME
            } else if (playType == 6){
                timeString += "1天"
            }
            if (playType == 6){
                return timeString;
            }

            if (ts > HOUR_TIME){
                timeString += checkTime(parseInt(ts / HOUR_TIME, 10)) + "小时"
                ts -= parseInt(ts / HOUR_TIME, 10) * HOUR_TIME
            }
            if (ts > MINUTE_TIME){
                timeString += checkTime(parseInt(ts / MINUTE_TIME, 10)) + "分钟"
                ts -= parseInt(ts / MINUTE_TIME, 10) * MINUTE_TIME
            }
            if (ts > 1000){
                timeString += checkTime(parseInt(ts / 1000, 10)) + "秒"
                ts -= parseInt(ts / 1000, 10) * 1000
            }
            return timeString;
        }

        if (prizeType == '102'){
            var curTime = sysTime
            function timer(interval){
                var liveTime = parseInt($('#liveTime').val(), 10)
                curTime += interval
                var ts = liveTime - curTime;
                var timeString = ''
                if (ts < 0){
                    timeString += '直播已开始';
                } else {
                    timeString += '直播开始剩余时间';
                }
                timeString += getXCTime(ts);
                $('#live-timer').show().html(timeString);
                setTimeout(timer, 1000, 1000)
            }
            timer(0)
        }

        function checkTime(i){
            if (i < 10) {
                i = "0" + i;
            }
            return i;
        }
        var unit = $('#integralUnit').val() || '积分';
        var buyTime = sysTime
        function buyTimer(interval){
            if (startTime && endTime){
                startTime = parseInt(startTime, 10)
                endTime = parseInt(endTime, 10)
                buyTime += interval
                var now = buyTime
                var timeString = ''
                if (now < startTime){
                    if (playType == '1'){
                        timeString += '离'+unit+'兑换开始还有';
                    } else if (playType == '2'){
                        timeString += '离购买开始还有';
                    } else if (playType == '6'){
                        timeString += '离众筹开始还有';
                    }
                    timeString += getXCTime(startTime - now)
                    if (playType != '6'){
                        $('#buy-timer').show().html(timeString);
                    } else {
                        $('#buy-timer').hide()
                        $('.progress').find('.text').text('未开始')
                        $('#raise-progress').find('.day').text(getXCTime(startTime - now))
                        $('#raise-progress').find('.state').text('众筹未开始')
                    }
                } else if (now > endTime){
                    if (playType == '1'){
                        timeString += unit+'兑换';
                    } else if (playType == '2'){
                        timeString += '购买';
                    } else if (playType == '6'){
                        timeString += '众筹';
                    }
                    timeString += '已结束';
                    /*timeString += getXCTime(endTime - now)*/
                    if (playType != '6'){
                        $('#buy-timer').show().html(timeString);
                    } else {
                        $('#buy-timer').hide()
                        $('.progress').find('.text').text('已结束')
                        $('#raise-progress').find('.day').text('')
                        $('#raise-progress').find('.state').text('众筹已结束')
                    }
                } else {
                    if (playType == '1'){
                        timeString += '离'+unit+'兑换结束还剩';
                    } else if (playType == '2'){
                        timeString += '离购买结束还剩';
                    } else if (playType == '6'){
                        timeString += '离众筹结束还剩';
                    }
                    timeString += getXCTime(endTime - now)
                    if (playType != '6'){
                        $('#buy-timer').show().html(timeString);
                    } else {
                        $('#buy-timer').hide()
                        $('.progress').find('.text').text('众筹中')
                        $('#raise-progress').find('.day').text(getXCTime(endTime - now))
                        $('#raise-progress').find('.state').text('剩余时间')
                    }
                }
                setTimeout(function(){
                    if (playType != '6'){
                        buyTimer(1000);
                    }
                }, 1000)
            }
        }
        buyTimer(0)

        if (playType == 6){
            var num=0;
            var owidth=0;
            var timer = null;
            var goodsId = $('#goodsId').val()

            function showProgress(progress){
                if(num <= progress && num <= 100){
                    owidth++;
                    $(".pro").width(owidth+"%");
                    $(".percent").text(num+"%");
                    num++;
                } else {
                    $(".pro").width(owidth+"%");
                    $(".percent").text(progress + "%");
                    clearInterval(timer)
                }
            }
            $('#raise-progress').show()

            var url = '/pointMall/raise/goods/' + goodsId + '/progress'
            $.ajax({
                method: "GET",
                url: url,
                success: function(data){
                    var progress = Math.floor(data.money / data.totalMoney * 1000) / 10
                    timer = setInterval(showProgress, 30, progress);
                    var userNumber = data.userNumber;
                    $('#raise-progress').find('.money').text('￥' + data.money);
                    $('#raise-progress').find('.user-num').text(data.userNumber);
                },
                error: function(xhr){

                }
            })
        }

        function reloadPage(time, flag){
            var random = Math.random() * 10000
            if (flag){
                random = 0
            }

            var t = time + random
            if (t > 12 * 60 * 60 * 1000){
                t = 12 * 60 * 60 * 1000
            }
            setTimeout(function(){
                window.location.reload()
            }, t)
        }

        if ($('#unload').val()){
            return window.location.reload()
        }

        var count = parseInt($('.number').attr('count'), 10);
        var now = sysTime
        if ((count <= 0 && !lotteryId) || unablePay){
            $('#convert').css('background-color', 'gray')
            $('#lottery-convert').css('background-color', 'gray')
            return $('#buy').css('background-color', 'gray')
        } else {
            if ((startTime && parseInt(startTime, 10) > now)){
                reloadPage(parseInt(startTime, 10) - now)
            } else if (endTime && now < parseInt(endTime, 10)) {
                reloadPage(parseInt(endTime, 10) - now, true)
            }
            if (prizeType == '102' || (startTime && parseInt(startTime, 10) > now) || (endTime && now < parseInt(endTime, 10))){
                $(window).unload(function(){
                    $('#unload').val(1)
                })
            }

            if ((startTime && parseInt(startTime, 10) > now) || (endTime && now > parseInt(endTime, 10))){
                $('#convert').css('background-color', 'gray')
                $('#lottery-convert').css('background-color', 'gray')
                return $('#buy').css('background-color', 'gray')
            }
        }

        $('.follow_pop_tip .cancel').click(function(){
            $('.follow_pop_tip').hide()
        })

        $('.follow_pop_tip .follow').click(function(){
            $('.follow_pop_tip').hide()
            if ($('#followUrl').val()){
                return window.location.href = $('#followUrl').val();
            }
        })

        $('#convert').click(function(){
            console.log('convert')
            if ($('#unFollowed').val() == 1){
                return $('.follow_pop_tip').show()
            }

            if (hasRule){
                return $(".wrap_option").show();
            } else {
                doChange()
            }
        })

        $('#tip').find('.close').click(function(){
            $('#tip').hide();
        })

        function getSelectRule(){
            var data = {}
            $('#rule-select .custom').each(function(){
                var title = $(this).attr('title')
                var v = $(this).find('.select_cur').text()
                data[title] = v;
            })
            return data;
        }

        function doChange(){
            window.location.href = '/pointMall/goto/exchange/goods/' + prizeId + '?rule=' + JSON.stringify(getSelectRule())
        }

        function doLotteryChange(){
            if (!lotteryId){
                return;
            }
            window.location.href = '/pointMall/goto/exchange/goods/' + prizeId + '?lotteryId=' + lotteryId + '&rule=' + JSON.stringify(getSelectRule())
        }

//        function doBuy(){
//            var rule = getSelectRule()
//            var url = '/pointMall/goods/' + prizeId + '/submit/order?rule=' + JSON.stringify(rule);
//            window.location.href = url;
//        }
        function doBuy(){
            var rule = getSelectRule();
            var url;

            if(isVip===true){
                var data=$('.select_cur').data();
                var vipSku={

                    day:data.day,
                    price:data.price
                }
                url = '/pointMall/goods/' + prizeId + '/submit/order?vipSku=' + JSON.stringify(vipSku);

                window.location.href = url;
                return false;
            }
//            console.log('rule is:',rule);return false;
            url = '/pointMall/goods/' + prizeId + '/submit/order?rule=' + JSON.stringify(rule);
            console.log('url is:',url);
            window.location.href = url;
        }

        $('#lottery-convert').click(function(){
            if (hasRule){
                $(".wrap_option").show();
            } else {
                doLotteryChange();
            }
        })

//        $('#buy').click(function() {
//            if ($('#unFollowed').val() == 1){
//                return $('.follow_pop_tip').show()
//            }
//
//            if (hasRule){
//                $(".wrap_option").show();
//            } else {
//                doBuy();
//            }
//        })
        $('#buy').click(function() {
//            var $vipSku=$('#vipSku'),
//                    val=$vipSku.val().trim();
            if ($('#unFollowed').val() == 1){
                return $('.follow_pop_tip').show()
            }

            if(isVip===true){
                $(".wrap_option").show();
                return false;
            }


            if (hasRule){
                $(".wrap_option").show();
            } else {
                doBuy();
            }
        })
    })
</script>
</body>
</html>
