<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>行为管理</title>

<link href="/pointMall/stylesheets/mass-group.css" type="text/css" rel="stylesheet"/>
<link href="/pointMall/stylesheets/style_mn-group.css" rel="stylesheet" type="text/css"/>

    <style type="text/css">
        .mass_content_top li.active{border-color:#999999;}
        .s_tab_reply{ position:relative}
        .s_tab_reply ul li{ float:left;border-radius:5px;}
        .s_tab_reply ul li:hover{ background:#f1f1f1;}
        .s_tab_reply ul li.on{ background:#576477;  color:#fff}
        .s_tab_reply ul li strong{ display:inline-block; border-left:solid 1px #ddd; margin:8px 0;padding:0 15px; font-weight:normal; font-size:14px; line-height:14px; cursor:pointer}
        .s_tab_reply ul li.on strong{ margin:0; line-height:30px}
        .s_tab_reply ul li:first-child strong{ border:0}
        .icos2 a.chou{color:#5bc96d}
        .icos2 a.chou2{color:#f0081e}
        .s_tab_reply .tip_r{ position:absolute; right:0; top:30px;}
        .tip_r a{width:80px; height:32px; border-radius:4px; background:#ef6e12; display:block; color:#fff; text-align:center; line-height:32px;}
        .btn_clear .ico_fun_btn{border:0; background:none;}
        .btn_clear .list_msg1 li,.btn_clear .ico_fun_btn li{border:0; width:40px; padding:0; margin:0;}
        .msg_manage_top .search2{bottom:13px; position:absolute; right:0;}
        .snap{background:none; float:left; padding:0;}
        .snap label {width:74px; height:32px; line-height:32px; margin-right:8px;}
        .list_msg1 li{padding:25px 7px;}
        .list_msg1 .min_padding{background:#eee; padding:7px;}
        .list_msg1 li .t1 td {
            vertical-align: middle;
            text-align:center;
            color:#666;
        }
        .list_msg1 li .t1 td.g_left{text-align:left;}
        .btn_clear{ position:relative;}
        .btn_clear .ico_fun_btn{ position:absolute; top:15px; left:50%; margin-left:-61px;}
        .ico_fun_btn li span{left:10%;}
        .pagenavi {
            padding: 15px 20px 50px 0;
        }
        .layer_w{width:419px; height:220px;}
        .layer_w .con{height:110px;}
        .frm_d{ padding:40px 0 0 79px;}
        .frm_d label{float:left; font-size:14px; width:50px; line-height:34px;}
        .frm_d input.frm_input{ border:1px solid #e5e5e5; font-size:14px; color:#333; padding:7px 10px; width:198px;}
        .layer_w{display:none; position:fixed; top:50%; left:50%; border-radius:4px; overflow:hidden; margin:-110px 0 0 -208px;}
        .bg{width:100%; height:100%; background:#000; opacity:0.3; position:fixed; top:0; display:none;}
        .top_l li input, .top_l li select{margin-right:20px;}

        .top_l li {
            margin-bottom: 15px;
        }
        .top_l li input.Wdate2 {
            width: 140px;
        }
    </style>

</head>

<body>
<div class="mass_content mass_content2">
    <div class=" clearfix have_border msg_manage_top">
        <ul class="fl clearfix top_l">
            <li><label>昵称：</label><input type="text" id="nickName" placeholder="请输入昵称">
                <label>所在地区：</label>
                <!--<select name="" id="">-->
                <!--<option value="">北京</option>-->
                <!--<option value="">天津</option>-->
                <!--</select>-->
                <input type="text" id="area" placeholder="请输入地区">
                <label>开始时间：</label>
                <input type="text" id="startTime" class="Wdate Wdate2"
                       onfocus="WdatePicker({dateFmt:'yyyy-MM-dd HH:mm:ss',disabledDates:['%y-%M-%d {%H-1}\:..\:..','%y-%M-%d {%H+1}\:..\:..']});"/>
                <label>结束时间：</label><input type="text" id="lastTime" class="Wdate Wdate2"
                                           onfocus="WdatePicker({dateFmt:'yyyy-MM-dd HH:mm:ss',disabledDates:['%y-%M-%d {%H-1}\:..\:..','%y-%M-%d {%H+1}\:..\:..']});"/>
            </li>
            <li>
                <label>行为：</label><input type="text" id="behavior_0" class="txt2" placeholder="请输入搜索条件"><a
                    class="tianxiang" href="#">+搜索项</a>
            </li>
        </ul>
        <div class="search2">
            <div class="snap">
                <label onclick="sub();">查看</label>
            </div>
            <div class="tianjia">
                <label onClick="btnEdit();">+添加分组</label>
            </div>
        </div>
    </div>
    <ul class="list_msg1 list_msg2">
        <li class="min_padding">
            <table width="100%" border="0" cellspacing="0" cellpadding="0" class="t1">
                <colgroup>
                    <col width="65">
                    <col width="*">
                    <col width="22%">
                    <col width="22%">
                    <col width="22%">
                </colgroup>
                <tr>
                    <td>头像</td>
                    <td>昵称</td>
                    <td>时间</td>
                    <td>所在地区</td>
                    <td>用户行为</td>
                </tr>
            </table>
        </li>
        <div id="behaviorList">
            <!--  data -->
        </div>

        <div id="queryGroup" style="text-align: right; margin-top: 20px; overflow: hidden;padding-bottom: 20px;">
            <a onclick="queryBehavior();"
               style="display: inline-block; background-color: #999; color: #FFF; padding:8px 15px;">查看更多</a>
        </div>

    </ul>
</div>
<!--<div class="pagenavi">-->
<!--<em class="pre">-->
<!--<strong></strong>-->
<!--</em>-->
<!--<span class="page_st">2/11</span>-->
<!--<em class="next">-->
<!--<strong></strong>-->
<!--</em>-->
<!--<span class="input_number">-->
<!--<input type="text" name="">-->
<!--</span>-->
<!--<span class="btn_send">跳转</span>-->
<!--</div>-->

<div class="bg"></div>
<div class="layer_w">
    <div class="header">请您添加分组<span class="close" onClick="top.xdDialog.close();">关闭</span></div>
    <div class="con">
        <div class="frm_d">
            <label>分组：</label>
            <input type="text" id="groupName" class="frm_input" id="inputTet" maxlength="" placeholder="请输入名称">
        </div>
    </div>
    <div class="btn_group">
        <span class="btn btn_lg btn_primary"><button type="button" onClick="addGroup();">确定</button></span>
    </div>
</div>

<input id="wxToken" type="hidden" value="{{{wxToken}}}">


<script type="text/javascript" src="/pointMall/javascripts/My97DatePicker/WdatePicker.js" charset="utf-8"></script>
<script type="text/javascript" src="/pointMall/javascripts/My97DatePicker/calendar.js" charset="utf-8"></script>
<script type="text/javascript" src="/pointMall/javascripts/My97DatePicker/lang/en.js"></script>
<script type="text/javascript" src="/pointMall/javascripts/My97DatePicker/lang/zh-cn.js"></script>
<script type="text/javascript" src="/pointMall/javascripts/My97DatePicker/lang/zh-tw.js"></script>
<script src="/pointMall/javascripts/jquery-1.7.1.min.js"></script>


<script type="text/javascript">

var wxToken = $('#wxToken').val();
var page = 1;
var pagecount = 10;
$('#queryGroup').hide();
var nickName = '', behavior = '', startTime = '', lastTime = '', area = '';
var isQuery = false;

$(function () {
    var num = 1;
    $('.tianxiang').click(function () {
        var num = $('.txt2').length;
        var mytag = $('<input type="text" id="behavior_' + num + '" class="txt2" placeholder="请输入搜索条件">');
        $(this).prev().after(mytag);
        if (num > 3) {
            $('.tianxiang').css('display', 'none');
        }
        num++
    });

    queryBehavior();

});

$('.close').click(function () {
    $('.layer_w').css('display', 'none');
    $('.bg').css('display', 'none');
});
$('.tianjia').click(function () {
    if (isQuery === false) {
        alert('请先点击查看，检索');
        return false;
    }
    $('.layer_w').css('display', 'block');
    $('.bg').css('display', 'block');
});
$('.btn_lg').click(function () {
    // $('.layer_w').css('display','none');
    // $('.bg').css('display','none');
});

function queryBehavior() {
    var _behavior = behavior;
    var _nickName = nickName;
    var _startTime = startTime;
    var _lastTime = lastTime;
    var _area = area;
//    console.log('--------------------------分页-------------------------------');
//    console.log('behavior--------',_behavior);
//    console.log('nickName--------',_nickName);
//    console.log('startTime--------',_startTime);
//    console.log('lastTime--------',_lastTime);

    loadData(_nickName, _behavior, _startTime, _lastTime, _area);
}

function inquiry(behaviorNmae) {
    var _behavior = behaviorNmae;
    var _nickName = nickName;
    var _startTime = startTime;
    var _lastTime = lastTime;
    var _area = area;
    $('#behaviorList').html('');
    page = 1;
    behavior=behaviorNmae;
    loadData(_nickName, _behavior, _startTime, _lastTime, _area);
}

function sub() {

    var _behavior = ''
    var _nickName = $('#nickName').val();
    var behavior_0 = $('#behavior_0').val();
    var behavior_1 = $('#behavior_1').val();
    var behavior_2 = $('#behavior_2').val();
    var behavior_3 = $('#behavior_3').val();
    var behavior_4 = $('#behavior_4').val();
    var _area = $('#area').val();
    var _startTime = $('#startTime').val();
    var _lastTime = $('#lastTime').val();


    if (document.getElementById("behavior_0") && behavior_0 != '') {
        _behavior += behavior_0;
    }
    if (document.getElementById("behavior_1") && behavior_1 != '') {
        _behavior += ',' + behavior_1;
    }
    if (document.getElementById("behavior_2") && behavior_2 != '') {
        _behavior += ',' + behavior_2;
    }
    if (document.getElementById("behavior_3") && behavior_3 != '') {
        _behavior += ',' + behavior_3;
    }
    if (document.getElementById("behavior_4") && behavior_4 != '') {
        _behavior += ',' + behavior_4;
    }

    if (_behavior === '') {
        alert('请输入行为搜索条件');
        return false;
    }

    if (_startTime != '' || _lastTime != '') {
        if (_startTime === '') {
            alert('请输选择起始时间');
            return false;
        } else {
            _startTime = datetime_to_unix(_startTime);
        }
        if (_lastTime === '') {
            alert('请输选择结束时间');
            return false;
        } else {
            _lastTime = datetime_to_unix(_lastTime);
        }
        if (_startTime > _lastTime) {
            alert('起始时间不能大于结束时间');
            return false;
        }
    }
//        console.log('behavior--------',_behavior);
//        console.log('nickName--------',_nickName);
//        console.log('startTime--------',_startTime);
//        console.log('lastTime--------',_lastTime);

    behavior = _behavior;
    nickName = _nickName;
    startTime = _startTime;
    lastTime = _lastTime;
    area = _area;
    $('#behaviorList').html('');
    isQuery = true;
    page = 1;
    loadData(_nickName, _behavior, _startTime, _lastTime, _area);
}

function loadData(nickName, behavior, startTime, lastTime, area) {
    var url = '/pointMall/behavior/query?wxToken=' + wxToken + '&startTime=' + startTime + '&lastTime=' + lastTime + '&nickName=' + nickName + '&behavior=' + behavior + '&area=' + area + '&page=' + page + '&pagecount=' + pagecount;
    $.ajax({
        type: 'GET',
        url: url,
        success: function (data) {
            if (data && data.status === 'success') {
                var dataArray = data.data;
                var html = '';
                for (var i = 0; i < dataArray.length; i++) {
                    var obj = dataArray[i];
                    html += '<li><table width="100%" border="0" cellspacing="0" cellpadding="0" class="t1">' +
                            '<colgroup><col width="65"><col width="*"><col width="22%"><col width="22%"><col width="22%"></colgroup>' +
                            '<td class="avatar"><div class="pic"><a href="#"><img src="' + obj.headImg + '"></a></div></td>' +
                            '<td class="date">' + obj.nickName + '</td>' +
                            '<td class="date">' + obj.dateTime + '</td>' +
                            '<td>' + obj.area + '</td>' +
                            '<td><a href="javascript:inquiry(\'' + obj.behavior + '\')">' + obj.behavior + '</a></td>' +
                            '</tr></table>' +
                            '</li>';
                }
                $('#behaviorList').append(html);
                page++;
                if (dataArray.length < pagecount) {
                    $('#queryGroup').hide();
                } else {
                    $('#queryGroup').show();
                }
            }
        },
        error: function (error) {
            console.log(error);
        }
    });
}

function addGroup() {
    var groupName = $('#groupName').val();
    if (groupName === '') {
        alert('请输入组名称');
        return false;
    }
    var dataObj = {
        groupName: groupName,
        wxToken: wxToken,
        nickName: nickName,
        behavior: behavior,
        area: area,
        startTime: startTime,
        lastTime: lastTime
    };
    $.ajax({
        type: 'POST',
        url: "/pointMall/groups/add",
        data: dataObj,
        success: function (data) {
            if (data) {
                if (data.status === 'success') {
                    window.location.href = '/pointMall/groups/index?wxToken=' + wxToken;
                } else {
                    if (data.code && data.code === 'M000') {
                        alert(data.msg);
                    } else {
                        console.log(data.msg);
                    }
                }
            } else {
                console.log('保存失败');
            }
        },
        error: function (error) {
            console.log(error);
        }
    });
}


function datetime_to_unix(datetime) {
    var tmp_datetime = datetime.replace(/:/g, '-');
    tmp_datetime = tmp_datetime.replace(/ /g, '-');
    var arr = tmp_datetime.split("-");
    var now = new Date(Date.UTC(arr[0], arr[1] - 1, arr[2], arr[3] - 8, arr[4], arr[5]));
    return parseInt(now.getTime());
//        return parseInt(now.getTime()/1000);
}

function unix_to_datetime(unix) {
    var now = new Date(parseInt(unix) * 1000);
    return now.toLocaleString().replace(/年|月/g, "-").replace(/日/g, " ");
}


</script>
</body>
</html>
